# 04. NCP에 DNS, CDN, AutoScaling 구현

- DNS, CDN, Load Balancer 구현
- 서버들을 로드밸런서로 묶고 DNS에 등록도 해보고 CDN 반영, 그리고 Auto Scaling을 통해서 사용자의 트래픽이 변화함에 따라 인프라가 유동적으로 변하는 것을 확인



## Load Balancer

- 네트워크 카테고리에 로드 밸런서 있음
- 로드 밸런서 생성
  - 로드밸런서 이름 설정
  - 네트워크
    - Private IP
      - 서버들끼리 서버들간에 통신할 때도 로드밸런서를 통해서 통신할 필요성이 있음
      - 예를 들어서 배치 서버, 어드민 서버, 왓슨 서버처럼 실제로 서버 내부에 있지만 외부에 노출될 필요는 없고 서버간 통신할 때 이중화, 노드를 분배시키기 위해서 private IP에 로드밸런서를 구성할 필요가 있음
    - Public IP
      - 일반적으로 웹 서비스와 같이 외부에 노출되는 서비스들을 로드밸런서로 구성할 때 사용
  - Zone 선택
    - KR1
    - KR2
    - 하나만 선택하면 하나에 두 개의 로드밸런서가 생성
  - 로드밸런서 설정
    - 프로토콜
      - HTTP, TPS, SSL, TCP
      - 로드밸런서는 OSI 7레이어에서 레이어 4(트랜스포트 레이어)에서 동작
      - 트랜스포트 레이어는 TCP 포트, UDP 포트만 인식, 그래서 기본적으로 로드밸런서는 헬스 체크를 포트에 대해서 수행
      - TCP를 제외한 나머지 프로토콜은 HTTP에 대해서 로드밸런싱을 하는게 아닌 HTTP, TPS, SSL은 오른쪽 항목에 L7 헬스 체크가 있는데 L7 헬스 체크 기능을 활성화 시키는 것임
      - 웹 서버는 살아있지만 실제로 서비스는 되지 않는 즉, 80포트는 살아있으나 웹 서버가 제대로 동작하지 않음. 이때 로드밸런서는 80포트가 살아있기 때문에 트래픽을 넘김. 하지만 사용자는 에러 페이지를 봄
      - 그래서 L7 헬스 체크를 통해서 포트 뿐만 아니라 웹 서비스가 서비스를 하고 있는지 체크
      - /(루트 url)로 설정되어 있는데 사실은 index.html이 생략되있음
    - Sticky Session
      - A 클라이언트가 3번 서버에 접속하면 다음에 접속할 때도 A 클라이언트는 3번 서버로만 가게 함.
      - 웹 서버만 적용.
      - 특정 클라이언트가 특정 서버로만 접속하게끔 하는 기능이 스티키 세션
      - 소스 IP 해시는 IP를 기반으로 하고 스티키 세션은 쿠키를 기반으로 동작
    - 헬스체크는 6초를 기준으로 체크
    - 연속으로 3번 Fail나면 언바인딩(더 이상 서버가 유용하지 않기 떄문에 L4에서는 그 서버를 서비스 제외시키겠다)
    - 연속으로 3 번 Ok가 나면 바인딩(서버를 L4에서 밸런싱하겠다란 용어)
  - 로드밸런싱 알고리즘
    - Round Robin
    - Least Connection
    - Source IP Hash
- 서버추가
  - 로드밸런서에 어떤 서버를 넣을지 선택하는 화면
  - 실습에서는 lab1-org2, lab1-org 서버 추가
- 로드밸런서 생성
- 로드밸런서가 만들어지면 접속 정보에는 IP가 아닌 도메인(호스트) 형태의 접속 정보를 제공
  - 떄문에 나중에 DNS에 로드밸런서를 등록하려면 A 레코드 타입이 아닌 CNAME 레코드 타입으로 지정
- 접속 정보로 접속하면 공인 IP로 접속한 IP와 로드밸런서로 접속한 IP가 다름
  - proxy방식이기 때문에 서버 입장에서 봤을 때 로드밸런서를 이용한 접속에서는 클라이언트의 IP는 로드밸런서의 IP가 찍힘
  - 실제 로드밸런서 IP
    - DNS 조회 명령어
      - nslookup <로드밸런서 접속 정보>
- 다 만들면 HTTP Keep-alive, Connection Idle Timeout설정이 있음
  - 디폴트는 Off, 60초로 설정되있고 바꿀 수 있음
  - 웹 서비스의 성격에 따라서 웹 서버의 설정에 따라 설정해야만 유효함



## DNS

10:16