# 04. NCP에 DNS, CDN, AutoScaling 구현

- DNS, CDN, Load Balancer 구현
- 서버들을 로드밸런서로 묶고 DNS에 등록도 해보고 CDN 반영, 그리고 Auto Scaling을 통해서 사용자의 트래픽이 변화함에 따라 인프라가 유동적으로 변하는 것을 확인



## Load Balancer

- 네트워크 카테고리에 로드 밸런서 있음
- 로드 밸런서 생성
  - 로드밸런서 이름 설정
  - 네트워크
    - Private IP
      - 서버들끼리 서버들간에 통신할 때도 로드밸런서를 통해서 통신할 필요성이 있음
      - 예를 들어서 배치 서버, 어드민 서버, 왓슨 서버처럼 실제로 서버 내부에 있지만 외부에 노출될 필요는 없고 서버간 통신할 때 이중화, 노드를 분배시키기 위해서 private IP에 로드밸런서를 구성할 필요가 있음
    - Public IP
      - 일반적으로 웹 서비스와 같이 외부에 노출되는 서비스들을 로드밸런서로 구성할 때 사용
  - Zone 선택
    - KR1
    - KR2
    - 하나만 선택하면 하나에 두 개의 로드밸런서가 생성
  - 로드밸런서 설정
    - 프로토콜
      - HTTP, TPS, SSL, TCP
      - 로드밸런서는 OSI 7레이어에서 레이어 4(트랜스포트 레이어)에서 동작
      - 트랜스포트 레이어는 TCP 포트, UDP 포트만 인식, 그래서 기본적으로 로드밸런서는 헬스 체크를 포트에 대해서 수행
      - TCP를 제외한 나머지 프로토콜은 HTTP에 대해서 로드밸런싱을 하는게 아닌 HTTP, TPS, SSL은 오른쪽 항목에 L7 헬스 체크가 있는데 L7 헬스 체크 기능을 활성화 시키는 것임
      - 웹 서버는 살아있지만 실제로 서비스는 되지 않는 즉, 80포트는 살아있으나 웹 서버가 제대로 동작하지 않음. 이때 로드밸런서는 80포트가 살아있기 때문에 트래픽을 넘김. 하지만 사용자는 에러 페이지를 봄
      - 그래서 L7 헬스 체크를 통해서 포트 뿐만 아니라 웹 서비스가 서비스를 하고 있는지 체크
      - /(루트 url)로 설정되어 있는데 사실은 index.html이 생략되있음
    - Sticky Session
      - A 클라이언트가 3번 서버에 접속하면 다음에 접속할 때도 A 클라이언트는 3번 서버로만 가게 함.
      - 웹 서버만 적용.
      - 특정 클라이언트가 특정 서버로만 접속하게끔 하는 기능이 스티키 세션
      - 소스 IP 해시는 IP를 기반으로 하고 스티키 세션은 쿠키를 기반으로 동작
    - 헬스체크는 6초를 기준으로 체크
    - 연속으로 3번 Fail나면 언바인딩(더 이상 서버가 유용하지 않기 떄문에 L4에서는 그 서버를 서비스 제외시키겠다)
    - 연속으로 3 번 Ok가 나면 바인딩(서버를 L4에서 밸런싱하겠다란 용어)
  - 로드밸런싱 알고리즘
    - Round Robin
    - Least Connection
    - Source IP Hash
- 서버추가
  - 로드밸런서에 어떤 서버를 넣을지 선택하는 화면
  - 실습에서는 lab1-org2, lab1-org 서버 추가
- 로드밸런서 생성
- 로드밸런서가 만들어지면 접속 정보에는 IP가 아닌 도메인(호스트) 형태의 접속 정보를 제공
  - 떄문에 나중에 DNS에 로드밸런서를 등록하려면 A 레코드 타입이 아닌 CNAME 레코드 타입으로 지정
- 접속 정보로 접속하면 공인 IP로 접속한 IP와 로드밸런서로 접속한 IP가 다름
  - proxy방식이기 때문에 서버 입장에서 봤을 때 로드밸런서를 이용한 접속에서는 클라이언트의 IP는 로드밸런서의 IP가 찍힘
  - 실제 로드밸런서 IP
    - DNS 조회 명령어
      - nslookup <로드밸런서 접속 정보>
- 다 만들면 HTTP Keep-alive, Connection Idle Timeout설정이 있음
  - 디폴트는 Off, 60초로 설정되있고 바꿀 수 있음
  - 웹 서비스의 성격에 따라서 웹 서버의 설정에 따라 설정해야만 유효함



## DNS

- dns를 이용해 편리하게 접속
  - A 레코드와 CNAME 레코드 추가
- 네트워크 카테고리에서 DNS 선택
  - 도메인 추가 선택
  - 도메인 이름 추가
- 생성하면 기본적으로 NS 레코드와 SOA 레코드가 추가되어 있음
  - 후이즈에는 후이즈의 네임서버를 지정해야 함
  - 후이즈나 가비아에서 도메인을 구매하면
    - 네임서버
      - ns1c1.ncloud-dns.com
      - ns2c1.ncloud-dns.com
      - ns3c1.ncloud-dns.com
      - ns4c1.ncloud-dns.com
    - 이렇게 네임 서버를 지정해주어야만 NCP에서 DNS 상품을 이용할 수 있음
  - 여기서 두 가지 레코드 추가
    - 레코드 명 : server1
    - 레코드 타입 : A
      - A는 레코드 값이 IP로 매핑
    - TTL은 일반적으로 서비스 성격에 맞게 설정
      - 여기서는 15분을 줌
    - 레코드 값 : 서버의 공인 IP
    - 두 번째 레코드는 로드밸런서를 www에 주소로 줌
      - 이때 로드밸런서는 도메인 정보로 접속 정보를 제공함. 그래서 A 레코드로 주면 에러가 발생
    - 레코드 명 : www
    - 레코드 타입 : CNAME 
    - 레코드 값 : 도메인
- 도메인으로 접속해도 네임서버가 활성화되어서 접속 가능



## CDN

- CDN을 사용하려면 Network카테고리에서 국내 CDN을 사용하기 때문에 CDN+(Domestic)선택
- 실습에서는 이미지를 CDN으로 서비스
- CDN 신청 버튼 선택
- 서비스 설정
  - 서비스 이름 설정
  - 서비스 프로토콜 : HTTP
  - 서비스 도메인
    - 고객 보유 도메인을 사용하려면 서비스 도메인(ex. cdn.edu110.ncloud.com)을 입력하고 DNS에서 해당 도메인을 CNAME으로 만들어야함
    - CDN을 만들면 로드밸런서와 마찬가지로 접속 정보가 나옴. 그 정보를 이용해 리다이렉트해주는 작업을 추가적으로 해야함
  - Access Log
    - 보통 Access Log는 CDN에 누가 접속을 했는지, 잘 접속이 됬는지, hit가 났는지 miss가 났는지 통계를 뽑아보기 위한 지표로 사용할 수 있음
    - 사용하면 오브젝트 스토리지에다가 저장할 수 있음
- 원본 설정
  - 원본 위치
    - Object Storage
    - 직접 입력
      - 공인 IP 입력
      - HTTP 80포트
  - 원본 경로(선택)
    - 디렉토리를 지정할 수 있는데 예제 서버는 단일 디렉토리이기 때문에 따로 설정하지 않음
  - 나머지 옵션들은 사용자 가이드를 보고 해당 옵션이 내 서비스에 맞는지 봐야됨
    - 내 서비스가 동영상 전송이면 압축같은 옵션은 효과가 없음
- 캐싱 설정
  -  Cache expiry
    - DNS에서 TTL과 같이 한번 캐싱되있는 데이터를 얼마나 더 유지를 시킬것인가, 얼마후에 갱신할 것인가를 선택할 수 있음
  - 다양한 보안 설정을 할 수 있음
- Viewer 전송 설정
  - Referrer Domain
    - 어떠한 경로를 통해서 왔는지를 확인하고 정상적인 경로로만 와야 컨텐츠를 제공하게 설정 가능
    - Referrer가 없는 경우에는 허용하지 않음
- Security Token
  - 허가된 사용자에 대해서만 컨텐츠를 허락하게 설정할 수 있음
- 생성하면 서비스 도메인이 생성
  - 서버 페이지에서 오른쪽 클릭 후 페이지 소스 보기 선택
  - 이미지에 대한 html의 src를
    - src='cdn도메인/logo1.jpg'로 설정
    - 이미지 파일을 웹 서버에서 나가는게 아닌 CDN을 통해서 내보내게 됨
- 처음 한번은 miss가 나지만 그 다음부터는 캐싱을 하고 있다가 사용자들에게 빠르게 컨텐츠를 제공
- 트래픽 비용, 서비스 비용 절감



## Auto Scaling

- 오토 스케일링은 기본적으로 인프라단에서 수행
- 클라우드에서 사용되는 하나의 전략이 스케일 아웃 전략
  - 사용자의 트래픽에 맞춰서 인프라가 능동적으로 변형되는게 오토 스케일링
- 오토 스케일링을 적용하기 위해서는 NCP에서 Compute 카테고리에  있음
  - 총 3가지의 설정이 필요
    - Launch Configuration
      - 서버의 스펙을 결정
      - 어떤 서버로 오토 스케일링의 서버를 생성할지
      - 누르면 마치 처음 서버를 만드는 것처럼 서버에 대한 내용이 나옴
      - 내 서버 이미지를 누르면 기존의 만든 이미지를 이용해 서버를 만듬
      - 일반적으로 오토 스케일링은 사용자의 트래픽이 증가했을 때 바로 반응하여 서버를 늘리는 것이기 때문에  내 서버 이미지로 기본적인 마스터본을 만들고 서버에 추가적인 설정이 필요할 때 쓸수 있는 기능이 Init Script
      - 내 서버 이미지와 Init Script를 중복해서 적용하여 서버 생성 시간을 줄일 수 있음
      - 스마트하게 오토 스케일링을 구성하면 내 서버 이미지에서 미리 마스터본을 만들어 놓고 해당 이미지를 불러온 동시에 업데이트된 내용은 Init Script를 통해서 불러오게 해주는게 효과적
    - Auto Scaling Group
      - 런치 컨피규레이션에서 만든 서버들을 몇대씩 언제 만들지에 대한 설정
      - 최대 30대의 서버를 만들 수 있음
    - Event Group
- Launch Configuration
  - 실습에서는 기본 이미지(깡통 서버)를 이용해 만듬
  - 기본 이미지
    - 50GB, OS, All 선택
    - 서버 이미지 이름 centos-7.3-64 선택
  - 서버 설정
    - 서버의 스펙을 설정
    - SSD, Standard, vCPU 2개, 메모리 4GB, SSD 500GB
    - Init Script : lab-script-7
  - 이름 설정
    - lab-lc로 설정
  - 인증키 설정
    - 보유하고 있는 ACI 설정
  - 최종 확인
    -  launch configuration에서 중요한 것은 어떤 서버 이미지(깡통, 기존 이미지)를 이용해서 만들지 그리고 서버 스펙을 어떻게 할지 인증키는 사실 오토 스케일링된 서버에 접속할 일은 없어야 함
    - ACG가 중요. 어떤 ACG에 포함시킬 것인가
      - 오토 스케일링에 의해서 서버가 만들어짐
      - 그 서버가 DB 서버에 접속을 할려면 DB 서버 ACL에 새로 만들어진 서버들이 접속할 수 있도록 허용해주어야 함
      - 때문에 ACG가 중요. 실제로 ACG를 통해서 오토 스케일링된 서버들도 웹 서비스를 하거나 DB 서버에 접속할 수 있게 됨
- Auto Scaling Group
  - 만들어놓은 Launch Configuration에서 선택
    - 사용자 별로 Launch Configuration과 Auto Scaling Group을 만들 수 있는 개수는 제한
  - 그룹 설정
    - 그룹 이름 설정
    - Zone 선택
    - 최소 용량, 최대 용량, 기대 용량
      - 오토 스케일링 서버는 능동적으로 수가 변함.
      - 기대 용량은 오토 스케일링으로 서버를 만들면 처음에 몇대로 시작할지 시작되는 서버의 대수를 설정하는 개수
    - 쿨다운
      - 서버가 정상적으로 올라와도 부팅 이후에 Init Script나 웹 서버가 기동하는데 시간이 필요. 그때 어느정도의 시간을 할당할지 결정
    - 헬스 체크 보류 기간
      - 로드 밸런서가 해당 설정 시간만큼 기다렸다가 헬스 체크를 시작하고 바인딩을 하게 됨
    - 헬스 체크 유형 : 로드 밸런서
    - 반납 정책
      - 기본적으로는 NCP에서 알아서 서버를 반납
      - 사용자가 서버가 반납되는 것을 막고 세션이 조금이라도 남아있으면 다 빠진 후에 서버를 반납해야 되는 필요성이 있을 때 고객이 API로 직접 지정을 선택해 사용자가 서버를 직접 반납
    - Nat Gateway 설정 가능
  - 정책/일정 설정
    - 일정 설정
      - 매주 수요일날 5시에 이벤트를 하면 미리 지정 날짜에 서버를 10대를 만들어 놓고 그 이후에 서버를 삭제
      - 이벤트 혹은 서비스에 대한 일정에 따라서 서버의 트래픽의 변동이 발생하는 경우에는 그 해당 일정에 맞춰서 서버를 유동적으로 늘렸다 줄였다할 수 있음
    - 정책 설정
      - 계획되어 있는 이벤트 기반이 아니라 계획에 없는 급격히 사용자가 몰리거나 빠지게 되면 그에 맞춰서 유동적으로 능동적으로 NCP의 오토스케일링이 알아서 서버를 늘리고 줄이게 함
      - 스케일링 설정
        - 증강변경 : 몇대씩 늘리고 줄일것인지
        - 비율변경 : 몇프로씩 늘릴고 줄일것인지
        - 고정값 : 무조건 특정 대수만큼 늘려놓거나 줄여놓을 것인지
  - 통보 설정
    - 오토스케일링이 발생할 때마다 통보를 받는 것이 좋음
- 언제 ADD 정책을 쓰고 언제 DEL 정책을 사용할지, 트래픽이 많다 적다의 기준을 안정함
- 해당 설정은 Management 카테고리 - Monitoring - Group  Event Setting에서 설정
- Group Event Setting
  - 오토 스케일링 그룹이 보임
  - 그룹 이벤트 설정 선택
    - 다양한 기준을 이용해서 설정 가능
    - 실습 예제
      - 이벤트 항목 : CPU
      - 임계치 : 50%
      - 지속시간 : 1분
      - 정책 : add
      - 임계치 : 30%
      - 지속시간 : 1분
      - 정책 : del
- 로드 밸런서에 해당 생성된 서버들이 보임
  - 기존 서버 2대와 오토 스케일링 서버 2대가 바인딩되어서 서비스

