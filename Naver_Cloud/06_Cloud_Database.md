# 06. Cloud Database

- NCP에서는 preinstall된 데이터베이스 이미지 형태로 제공하는 데이터베이스도 있지만 관리형 데이터베이스라고 불리우는 Cloud DB for MySQL, Cloud DB for Redis, Cloud DB for MS-SQL 상품도 존재
- Cloud DB for MySQL, Redis, MS-SQL에 대해서 자세하게 설명
- 사용자가 직접 서버에 MySQL을 설치하고 MySQL 서버의 루트 권한과 데이터베이스의 루트 권한, 데이터베이스의 모든 권한을 가지고 직접 컨트롤하는게 preinstall 데이터베이스
- Cloud DB for MySQL. Redis, MS-SQL은 사용자는 DB 인스턴스, 데이터베이스에 대한 접속 권한만 가지고 서버, DBMS에 대한 관리 권한은 NCP에서 관리를 하는 형태



## Cloud DB for MySQL

- 자동 Fail-Over 지원 및 사용자 환경에 맞는 구성 가능
  - 데이터베이스가 크러쉬(OS 또는 데이터베이스, 서버(하드웨어)에 대한 크러쉬일 수 있음)가 발생하더라도 데이터베이스는 중요성이 높기 때문에 서비스에 큰 영향을 미침. Fail-Over를 지원하기 때문에 사용자의 서비스가 연속성있게 지속적으로 서비스가 가능하게 지원
  - 최대 32vCPU에 256GB 메모리 지원, 2TB(최신버전은 6TB) 자동 디스크 확장 (Standard, High Memory)
  - 자동 Fail-Over를 지원하며 최대 5대까지 복제 Slave (Read Only) 확장 가능
    - 마스터 서버가 죽더라도 스탠바이 서버가 마스터로 올라오고 새로운 스탠바이 서버가 생성
  - Private Load Balancer를 이용해서 Read 부하 분산 가능
    - Write 쿼리는 마스터 서버
    - Read 쿼리는 스탠바이 서버
  - 자동 백업 주기를 설정할 수 있으며, 최대 30일 백업 파일 보관
- Master DB Failover
  - MySQL 데이터베이스 서버가 Failover될 때 실제로 어느정도 다운 타임이 발생하는지 시뮬레이션할 수 있도록 실제 서버를 수동으로 Failover를 함
    - 실제로 사용자의 서비스에 어느 정도의 임팩트가 있는지, 그리고 어느 정도의 시간이 걸리는지 측정 가능
    - 마스터 DB에 장애가 발생했을 때 문제가 생기면 어떻게 보완할지 시뮬레이션으로 Failover에 시간, 어떤 임팩트가 있는지 확인 가능
  - 콘솔에서 수동(Manual)으로 Failover를 실행할 수 있음
  - 서비스 오픈 전에 Master DB 장애로 Failover가 발생하는 상황을 재현하여 Application에 영향이 없는지 사전에 점검을 할 수 있음
- DB Process 모니터링
  - 네이버를 다년간 운영해온 MySQL 전문가들이 MySQL에서 필요로 하는 그리고 어떤 항목을 봤을 때 데이터베이스를 운영하는데 있어서 좋은 지표가 되는 부분들을 뽑아서 DB Process 모니터링으로 제공
  - DB Server 연결하여 수행 중인 Query를 확인할 수 있음
  - Slow Query 로그 외에도 특정 시점에 어떤 Query가 수행 중인지 확인할 수 있어 DB 상태를 점검하는데 도움을 받을 수 있음
  - 여기서 뽑은 데이터베이스 모니터링 지표들은 네이버에서 운영하면서 중요하게 여기는 지표들을 위주로 뽑은 지표
- Stand Alone 백업
  - 마스터와 스탠바이, 슬레이브가 아니라 마스터 혼자 Cloud DB for MySQL을 구성하고 싶다. 이 말은 Failover를 발생할 수 있는 상황이 오더라도 Failover를 하지 않겠다는 선언
    - 이렇게 구성하는 이유는 백업 데이터를 이용하는 케이스는 보통 통계, 데이터 추출인데 스탠바이까지 서버를 살려서 데이터를 추출할 필요가 없기 때문에 마스터만 이용하여 핸들링
  - Stand Alone 서버도 DB 백업을 사용할 수 있음
  - 데이터가 삭제되어도 백업 보관일 설정 내에서 백업으로 데이터를 복구 할 수 있음



## Cloud DB for Redis

- 데이터베이스가 있고 데이터베이스에 쿼리 속도를 빠르게 하기 위해 앞단에 캐시 디비 Redis를 둬서 사용하기도 하고 Redis 그 자체로 데이터베이스를 이용하기도 함
- 자동 복구(Fail-Over)를 통해 안정적으로 운영되는 완전 관리형 클라우드 인메모리 캐시 서비스
  -  Redis가 제공하지 않는 자동 Fail-over 기능을 독자적으로 개발하여 제공함으로써 장애발생 시에도 안정적인 서비스 제공
  - 설치 후 Redis와 OS 모니터링을 이용할 수 있으며 장애 또는 이벤트 발생 시 사용자의 메일, SMS로 장애 알람
  - Cloud DB for Redis는 캐시 디비가 CPU에 의존적이지 않고 CPU에 디펜던시가 없기 때문에 CPU는 2vCPU로 고정. 사용자가 선택할 수 있는 사이즈는 메모리 사이즈
  - 네이버 서비스에서 오랜 시간 검증된 Redis 설정을 기본으로 지원
  - Redis Cluster 미지원(향후 지원 예정)
    - 전통적으로 Redis는 캐시 사이즈를 늘리기 위해서 Cluster를 구성하고 Cluster에 서버를 포함시켜서 캐시 메모리를 늘리는 구성을 함



## Cloud DB for MS-SQL

- MS-SQL은 MS-SQL 스탠다드 에디션 2016을 제공
  - Cloud DB for MS-SQL에서 제공하는 기능은 마이크로소프트 사에 기본적으로 제공하는 기술인 올웨이즈 원을 이용하고 있음
- 네이버 서비스에서 검증된 최적화된 설정을 통해 안정적으로 운영되며, 장애가 발생하면 자동으로 복구
  - 안정적인 서비스 제공을 위해 장애 발생 시 자동 Fail-over 기능 제공(Principal(마스터) DB와 Mirror(스탠바이) DB 총 2대 생성)
    - MS-SQL은 MySQL과 다르게 슬레이브는 제공하지 않음
  - 설치 후 즉시 MSSQL과 OS 모니터링을 이용할 수 있으며, MSSQL의 동작 상황을 그래프를 통해 손쉽게 확인 가능
    - OS와 MSSQL, 버블차트와 같이 실제로 성능과 관련된 사용자가 어떻게 MSSQL을 사용하고 있는지 지표를 사용자에게 제공
  - 1분 단위의 쿼리 레벨 성능 분석을 지원하며 서비스 성능과 안정성을 향상



## 실습 Cloud DB for MySQL 생성

- 데이터베이스 카테고리 - Cloud DB for MySQL 선택

- DB Server 생성

  **서버 설정**

  - DB 엔진 버전 선택
    - MySQL은 4가지 버전 제공
    - NCP는 5.7.29가 가장 안정적
  - Zone 선택
  - DB Server 타입 선택
    - 서버에 대한 스펙
  - 데이터 스토리지 타입 선택
  - 데이터 스토리지 용량
    - 기본 10GB, 10GB씩 증가. 최대 6TB
  - 고가용성 지원
    - 디폴트는 체크된 상태
    - 마스터와 스탠바이 서버 2대를 만듬. 체크를 풀면 마스터 서버만 생성
  - 디비 서버 이름 설정(예제:lab-db)
  - 디비 서비스 이름(예제:lab_edu)
  - 서버가 만들어지면 서버들을 묶는 ACG가 자동으로 생성
    - 서버에서 데이터베이스에 접근할 때는 반드시 이 MySQL 데이터베이스에 ACG에서 접근할 서버들을 열어줘야 함

  **DB 설정**

  - USER_ID 설정(예제: student)
  - HOST(IP) 설정
    - `%`로 설정하면 모든 호스트에서 접근 가능
  - USER 암호 설정
  - DB 접속 포트(3306이 기본 포트)
  - 기본 DB 명(예제 : edu)
  - Backup 설정
    - 디폴트로 백업 설정
    - Backup 파일 보관 기간 설정
    - Backup 시간 : 자동으로 계속 백업
      - 트랜지션 로그를 이용해 최근 데이터로 이동

  **디비 생성**

- 서버를 만들면 Private 도메인이 나옴
  - 데이터베이스에 접근하기 위한 접속 경로
  - MySQL 어플리케이션에 접속할 때는 IP가 아니라 Private 도메인으로 접속
- Public 도메인
  - NCP의 내부에서 접속하는게 아닌 외부에서 접속하는 형태
  - DB 관리 - Public 도메인 관리 선택
    - Public 도메인 신청
- 사용자와 Slave를 추가할 수 있음
  - DB 관리 - Slave 추가
  - Read, Write 쿼리 분산을 위한 Slave 추가 가능
- DB 스텍 변경 가능
- DB User 관리
  - 사용자를 만들 수 있고 권한도 부여 가능
  - Read, CRUD, DDL 3가지의 권한 부여 가능
    - DDL이 디비의 모든 권한을 가짐
- 모니터링
  - OS 대시보드
    - 이 데이터베이스가 올라가있는 서버에 대한 지표
  - 디비 대시보드
  - Query Timeline
    - 특정 어떤 시점에 쿼리가 날라왔는지 어떤 쿼리가 수행됬는지 확인 가능
- 백업
  - 자동으로 백업
  - 백업된 데이터를 리스토어할 수 있음
  - 시점 복원을 통해 분단위로 복원 가능
  - 데이터베이스는 리스토어하면 기존 데이터베이스 오버라이트하는게 아닌 새로운 데이터베이스 서버를 만들고 새로운 데이터베이스 서버에 리스토어

