# 03. Network Service

## 네이버 클라우드 플랫폼 Networking

- 외부와의 통로, 내부와의 통로 뿐만 아니라 DNS, CDN과 같은 다양한 서비스를 제공
  - 유입되는 네트워크 트래픽을 백엔드 서버로 분기하기 위한 Load Balancer
  - 네임서버 제공하는 DNS
  - 요청 사용자에 가장 가까운 엣지 서버에서 캐싱된 파일을 제공하여 원본 부하를 낮출 수 있는 CDN 상품
  - Site-to-Site 연결을 위한 IPSEC VPN 상품
  - 비공인 IP를 가진 다수의 서버에게 단일 공인 IP를 이용한 외부 접속을 제공하는 NAT Gateway 제공
  - 글로벌 네트워크 트래픽을 백앤드 서버로 분기하기 위한 Global Route Manager



### Load balancer

- Load Balancer란
  - 로드를 분산하여 밸런싱을 맞춰주는 상품
  - 네이버 클라우드 플랫폼에서 로드 밸런서는 부하 분산을 위해 서버 앞단에서 트래픽을 분산하는 역할
  - 서버를 이중화하거나 가용성을 높일 때 서비스가 더 많은 트래픽을 받아들이고자 할 떄 사용하는 가장 기본적인 것
  - 네이버 클라우드 플랫폼에서는 소프트웨어 방식인 HAProxy를 이용하여 로드밸런싱
  - 기본적으로 로드밸런서 하나를 생성하면 실제 물리적으로는 HAProxy 서버 2개가 도메인에 바인딩되어 제공
    - 로드밸런서도 물리적인 하나의 장비
    - 장비가 문제가 생겼을 때 테이크 오버해서 페일 오버하는 시점이 필요
    - 어느 하나의 장비가 무너지더라도 다른 장비를 통해서 서비스를 연속성있게 지속시킬 수 있도록 다수의 로드밸런서 형성
  - 로드밸런서는 최대 6만 TPS(Transaction Per Second)까지 보장
- 연결 방식
  - Proxy 방식
    - 사용자는 별도의 설정없이 네이버 클라우드에서 로드밸런서를 구성할 수 있음
      - 다이렉트 방식이나 나트방식은 사용자가 직접 서버에 설정을 바꾸거나 서버의 내용을 수정해야 하는 불편함 존재
  - 따라서 서버에서는 클라이언트 IP를 확인하고자 할 때 별도의 설정이 필요
  - 클라이언트 IP를 확인하고자 할 때, SSL/TCP일 경우에는 Proxy Protocol 사용 HTTP/HTTPS일 경우 X-Forwarder 사용, 웹 서비스인 경우에는 ASP/ JSP/ PHP가 됬든 사용자의 IP를 확인할 수 있는 함수를 호출해서 실제 IP를 확인해야 함
- 로드밸런싱 알고리즘
  - 일반적으로 8가지 정도의 알고리즘이 있지만 네이버 클라우드 플랫폼에서는 가장 많이 사용하는 3가지의 알고리즘 제공
  - Roud Robin : 클라이언트에서 요청이 오면 서버에 1개씩 순차적으로 분배하는 방식
    - 밸런싱이 안 맞을 수 있지만 단순하고 부하가 줄어들게 됨
  - Least Connection : 클라이언트 연결이 제일 적은 서버에게 새로운 커넥션을 분배하는 방식
    - 로드밸런서가 서버에 커넥션이 몇개가 되있는지 알기 때문에 가정 적은 커넥션을 맺고 있는 서버에 새로운 연결을 해줌
  - Source IP Hash : 클라이언트 IP에 대한 해시테이블을 가지고 클라이언트 IP에 매핑되는 서버에 새로운 커넥션을 분배하는 방식
    - 클라이언트가 한번 접속한 서버가 지속적으로 접속하게 하는 방식
  - 나머지 방식은 주로 Weighted 방식
    - Weighted 방식은 서버에 스펙이 달라졌을 때 신규 서버에는 웨이트를 많이 주고 성능이 떨어지는 서버에 웨이트를 적게 주어 차별화해서 밸런싱을 해주는 로드를 분배시켜 주는 방식
    - 클라우드에서는 효용성이 없음
- 생성 후 설정 가능 내용
  - 생성할 때는 설정할 수 없고 로드밸런서를 만든 이후에 설정할 수 있음
  - 웹서버에서도 아래 2개가 활성화되어 있어야 함
  - HTTP Keep Alive On / Off (Default Off)
  - Connection Idle Time (Default : 60 Sec)
  - 웹 서비스에 특성에 맞게 적용해야 함



### DNS

- 도메인 등록 서비스
  - 도메인 네임 서버를 제공
    - 후이즈나 가비아에서 ncloud.com을 구입하고 실제로 네임서버에서 www는 이런 IP로 가고 지정
    - 이때 네임서버가 필요. 직접 구상하지 않고 네이버 클라우드 플랫폼에서 제공하는 네임 서버를 사용
  - 다양한 레코드 타입 지원(A, NS, PTR, AAAA, MX, CNAME, SPF, TXT)
  - 등록 도메인으로 인입되는 트래픽을 분기(Round Robin)
    - DNS를 로드밸런서처럼 이용 가능
  - 등록된 도메인에 대한 헬스 체크 불가



### CDN

- 네이버 홈페이지는 3MB정도의 사이즈, 이 안에 이미지도 있고 스크립트, 스타일시트 등이 있지만 90% 이상이 텍스트가 있음. 실제로 아주 작은 용량에 대해서만 네이버 웹 서버에서 사용자에게 서빙
- CDN을 사용하는 이유
  - 트래픽을 좀 더 사용자에게 빠르게 전달
  - 웹 서비스의 부하를 최대한 줄이기 위해

- 컨텐츠를 Caching하여 보다 빠르고 안정적으로 사용자에게 전송하는 서비스
  - 국내, 국외 주 서비스 지역에 따른 CDN 상품 분리 제공(CDN+ : 국내 전용, GCDN : 국외 전용)
    - CDN+은 국내 1위 지에스네오텍을 이용
    - GCDN은 글로벌 1위 사업자인 아카마인 이용
  - 원본은 NCP 오브젝트 스토리지 혹은 커스텀 오리진 서버를 둘 수 있음
  - 도메인은 랜덤 CDN 도메인(*.ntruss.com) 혹은 보유하고 있는 도메인 사용 가능
    - 도메인을 이용해서 게임, 모바일 등의 실제 어플리케이션에 이쪽 CDN 도메인에서 데이터를 가져오라고 명시를 해줘야만 실제로 CDN 이용 가능
  - 지원 프로토콜은 HTTP/S

- CDN이 언제 필요할까?
  - 게임과 같은 대규모 파일 배포나 이미지 서비스, 동영상 서비스 등 대규모로 트래픽이 발생하는 경우
  - 웹서버를 통해 배포하게 되면 웹 서버의 용량이 기하 급수적으로 커져야 함
    - 클라우드 플랫폼을 사용하면 공급자는 웹서버를 최대한 줄일 수 있어 최소한으로 줄일 수 있음
  - 이러한 대규모 트래픽에 효과적으로 대응하기 위한 서비스



### IPSEC VPN

- NCP에서 제공하는 VPN 서비스는 2가지
  - IPSEC VPN(network 카테고리)
    - 기존의 레거시 인프라 또는 IDC에서 운영하고 있는 서버들과 NCP안에 있는 고객의 서버를 안전하게 그리고 사설망 통신을 사용해서 데이터를 주고 받고자 할 때 사용
  - SSL VPN(security 카테고리)
    - NCP안에 있는 서버에 클라이언트(관리자 등)들이 접근하기 위해 사용

- 고객의 사내망과 NCP 간 사설 통신을 위한 IPSEC VPN
  - 고객의 사내망과 NCP간 사설 통신을 위한 망 to 망 연결
  - 고객의 VPN 장비와 NCP VPN 장비 간 터널링 연결 제공(통신 방식 호환이 되어야 함)
    - NCP 사용자 가이드에 프로파일링되어 있음
  - NCP 서버들은 Private Subnet 대역(192.168.x.x)으로 통신 필요
  - BW 최대 30Mbps 제공



### NAT Gateway

- 예제
  - 일반적으로 NCP에 있는 서버들이 외부의 특정 은행, 증권사, 통신사와 통신하기 위해서는 해당 통신사나 증권사, 은행에서 NCP과 통신하기 위해서 NCP 안에 있는 고객의 공인 IP로 통신을 하게끔. 그리고 그쪽의 통신사의 방화벽, 금융사의 방화벽에서 NCP안의 서버에 공인 IP를 특정 포트를 열어주게끔 운영
  - 하지만 불편함이 발생
    - NCP 서버들 각각마다 공인 IP를 할당해야 함
    - 그리고 서버들을 서브넷으로 지정하지 못함
    - 때문에 공인 IP 각각 마다 통신사, 금융사의 방화벽에 등록해야 함
    - 이 사이에 서버가 갑자기 늘어난다면 통신사나 금융사에 변경 요청을 보냄
    - 하지만 이 변경 요청이 바로 되지 않음
    - 때문에 빠르게 업데이트해야 하는 상황이 발생하면 상대방(통신사, 금융사)의 방화벽의 설정을 안바꾸고 NCP의 NAT IP만 가지고 상대방과 통신하게 하면
    - 서버가 계속해서 늘어나던 Auto Scaling을 걸어서 서버가 수십대가 되더라도 상대방과 통신하는 IP는 NAT Gateway에서 지정한 하나이기 때문에 상대방의 방화벽은 업데이트를 할 필요가 없어짐
  - 나가는 IP에 대해서 특정 IP를 달고 나가게끔하는 서비스가 NAT Gateway

- 비공인 IP를 가진 다수의 서버에게 대표 공인 IP를 이용한 외부 접속을 제공
  - NAT Gateway를 통해 외부로 접속할 때 사용되는 대표 공인 IP는 해당 NAT Gateway만 독점적으로 사용하는 IP
  - Auto Scaling과 연계된 자동 설정 제공
  - 보안상 다수의 공인 IP에 대한 ACL을 오픈할 수 없는 경우 혹은 공인 IP 생성 비용 절약 가능
- NAT Gateway는 설정할 때 일반적으로 모든 트래픽은 NCP에 NAT를 통해 나가고 지정된 상대방의 방화벽의 IP에 대해서만 NAT Gateway를 통해서 나감
  - 설정할 때 필요한 정보가 생김
    - 상대방의 IP(PIP)
    - 상대방의 방화벽에서 우리쪽의 IP를 열어주어야 되기 때문에 NAT Gateway 공인 IP가 생성
    - NAT Gateway 사설 IP 생성 : 사용자의 서버에서 상대방과 통신할 때 그 사설 IP를 바라보게끔 호스트 파일에 넣어주게끔 하기 위한 용도



### Global Route Manager

- 예제
  - 미국에 있는 사용자는 네이버를 이용하게 되면 미국에 있는 네이버 서버를 이용하고 일본에 있는 사용자는 일본에 있는 네이버 서버 그리고 유럽에 있는 사용자는 유럽의 네이버 서버를 이용
  - 그런데 네이버는 한국에 있는데 한국으로 안오고 미국 사용자가 네이버를 접속했을 때 미국에 있는 네이버 서버로 접속할 수 있을까
  - 글로벌 라우트 매니저에서 미국과 일본에 있는 DNS 서버들한테 사용자들이 www.naver.com의 IP를 알려달라고 질의를 던짐
  - 그때 한국의 네이버 서버의 IP를 리턴하지 않고 미국과 일본에 있는 서버의 IP를 리턴
  - 미국의 사용자가 미국에 있는 네이버 웹 서버에 접속할 수 있도록 하는 상품
  - 해외 각지에 서버를 만들고 어느 나라는 어떤 서버가 담당할지 매핑
  - 매핑하는 방식이 존재

- DNS 기반의 다양한 방법을 통해 네트워크 트래픽을 안정적으로 로드밸런싱하는 GSLB 상품
  - GSLB : 도메인 단위로 로드밸런싱하고 도메인 단위로 health check를 할 수 있는 기능
    - 다양한 리전에 웹 서버를 분산
    - 특정 리전에 문제가 생기면 나머지 리전으로 서비스를 하고자 할 때 GSLB를 사용
    - 로드 밸런서는 OSI 7layer 중 4에서 동작
      - 때문에 서버들이 반드시 같은 리전안에 있어야 함
  - 여러개의 리전을 만들어 놓고 동일한 웹 서비스를 한다라고 한다면 리전에 대해서 Health Check를 하고 리전에 대해서도 로드 밸런싱을 해야 함
    - 이때 사용할 수 있는게 GRM의 기능 중 하나인 GSLB
  - DNS 기반의 로드밸런싱 서비스 제공을 통해서 지역별 트래픽 기반 부하 분산, DR 구축 등에 사용할 수 있는 상품
  - 로드밸런싱 타입은 4가지 제공(Round Robin, Weighted, GeoLocation, Failover)
  - IP에 대한 Health Check만 제공

