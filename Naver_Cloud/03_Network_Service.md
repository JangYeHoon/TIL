# 03. Network Service

## 네이버 클라우드 플랫폼 Networking

- 외부와의 통로, 내부와의 통로 뿐만 아니라 DNS, CDN과 같은 다양한 서비스를 제공
  - 유입되는 네트워크 트래픽을 백엔드 서버로 분기하기 위한 Load Balancer
  - 네임서버 제공하는 DNS
  - 요청 사용자에 가장 가까운 엣지 서버에서 캐싱된 파일을 제공하여 원본 부하를 낮출 수 있는 CDN 상품
  - Site-to-Site 연결을 위한 IPSEC VPN 상품
  - 비공인 IP를 가진 다수의 서버에게 단일 공인 IP를 이용한 외부 접속을 제공하는 NAT Gateway 제공
  - 글로벌 네트워크 트래픽을 백앤드 서버로 분기하기 위한 Global Route Manager



### Load balancer

- Load Balancer란
  - 로드를 분산하여 밸런싱을 맞춰주는 상품
  - 네이버 클라우드 플랫폼에서 로드 밸런서는 부하 분산을 위해 서버 앞단에서 트래픽을 분산하는 역할
  - 서버를 이중화하거나 가용성을 높일 때 서비스가 더 많은 트래픽을 받아들이고자 할 떄 사용하는 가장 기본적인 것
  - 네이버 클라우드 플랫폼에서는 소프트웨어 방식인 HAProxy를 이용하여 로드밸런싱
  - 기본적으로 로드밸런서 하나를 생성하면 실제 물리적으로는 HAProxy 서버 2개가 도메인에 바인딩되어 제공
    - 로드밸런서도 물리적인 하나의 장비
    - 장비가 문제가 생겼을 때 테이크 오버해서 페일 오버하는 시점이 필요
    - 어느 하나의 장비가 무너지더라도 다른 장비를 통해서 서비스를 연속성있게 지속시킬 수 있도록 다수의 로드밸런서 형성
  - 로드밸런서는 최대 6만 TPS(Transaction Per Second)까지 보장
- 연결 방식
  - Proxy 방식
    - 사용자는 별도의 설정없이 네이버 클라우드에서 로드밸런서를 구성할 수 있음
      - 다이렉트 방식이나 나트방식은 사용자가 직접 서버에 설정을 바꾸거나 서버의 내용을 수정해야 하는 불편함 존재
  - 따라서 서버에서는 클라이언트 IP를 확인하고자 할 때 별도의 설정이 필요
  - 클라이언트 IP를 확인하고자 할 때, SSL/TCP일 경우에는 Proxy Protocol 사용 HTTP/HTTPS일 경우 X-Forwarder 사용, 웹 서비스인 경우에는 ASP/ JSP/ PHP가 됬든 사용자의 IP를 확인할 수 있는 함수를 호출해서 실제 IP를 확인해야 함
- 로드밸런싱 알고리즘
  - 일반적으로 8가지 정도의 알고리즘이 있지만 네이버 클라우드 플랫폼에서는 가장 많이 사용하는 3가지의 알고리즘 제공
  - Roud Robin : 클라이언트에서 요청이 오면 서버에 1개씩 순차적으로 분배하는 방식
    - 밸런싱이 안 맞을 수 있지만 단순하고 부하가 줄어들게 됨
  - Least Connection : 클라이언트 연결이 제일 적은 서버에게 새로운 커넥션을 분배하는 방식
    - 로드밸런서가 서버에 커넥션이 몇개가 되있는지 알기 때문에 가정 적은 커넥션을 맺고 있는 서버에 새로운 연결을 해줌
  - Source IP Hash : 클라이언트 IP에 대한 해시테이블을 가지고 클라이언트 IP에 매핑되는 서버에 새로운 커넥션을 분배하는 방식
    - 클라이언트가 한번 접속한 서버가 지속적으로 접속하게 하는 방식
  - 나머지 방식은 주로 Weighted 방식
    - Weighted 방식은 서버에 스펙이 달라졌을 때 신규 서버에는 웨이트를 많이 주고 성능이 떨어지는 서버에 웨이트를 적게 주어 차별화해서 밸런싱을 해주는 로드를 분배시켜 주는 방식
    - 클라우드에서는 효용성이 없음
- 생성 후 설정 가능 내용
  - 생성할 때는 설정할 수 없고 로드밸런서를 만든 이후에 설정할 수 있음
  - 웹서버에서도 아래 2개가 활성화되어 있어야 함
  - HTTP Keep Alive On / Off (Default Off)
  - Connection Idle Time (Default : 60 Sec)
  - 웹 서비스에 특성에 맞게 적용해야 함



### DNS

- 도메인 등록 서비스
  - 도메인 네임 서버를 제공
    - 후이즈나 가비아에서 ncloud.com을 구입하고 실제로 네임서버에서 www는 이런 IP로 가고 지정
    - 이때 네임서버가 필요. 직접 구상하지 않고 네이버 클라우드 플랫폼에서 제공하는 네임 서버를 사용
  - 다양한 레코드 타입 지원(A, NS, PTR, AAAA, MX, CNAME, SPF, TXT)
  - 등록 도메인으로 인입되는 트래픽을 분기(Round Robin)
    - DNS를 로드밸런서처럼 이용 가능
  - 등록된 도메인에 대한 헬스 체크 불가



### CDN

- 네이버 홈페이지는 3MB정도의 사이즈, 이 안에 이미지도 있고 스크립트, 스타일시트 등이 있지만 90% 이상이 텍스트가 있음. 실제로 아주 작은 용량에 대해서만 네이버 웹 서버에서 사용자에게 서빙
- CDN을 사용하는 이유
  - 트래픽을 좀 더 사용자에게 빠르게 전달
  - 웹 서비스의 부하를 최대한 줄이기 위해

- 컨텐츠를 Caching하여 보다 빠르고 안정적으로 사용자에게 전송하는 서비스
  - 국내, 국외 주 서비스 지역에 따른 CDN 상품 분리 제공(CDN+ : 국내 전용, GCDN : 국외 전용)
    - CDN+은 국내 1위 지에스네오텍을 이용
    - GCDN은 글로벌 1위 사업자인 아카마인 이용
  - 원본은 NCP 오브젝트 스토리지 혹은 커스텀 오리진 서버를 둘 수 있음
  - 도메인은 랜덤 CDN 도메인(*.ntruss.com) 혹은 보유하고 있는 도메인 사용 가능
    - 도메인을 이용해서 게임, 모바일 등의 실제 어플리케이션에 이쪽 CDN 도메인에서 데이터를 가져오라고 명시를 해줘야만 실제로 CDN 이용 가능
  - 지원 프로토콜은 HTTP/S

- CDN이 언제 필요할까?
  - 게임과 같은 대규모 파일 배포나 이미지 서비스, 동영상 서비스 등 대규모로 트래픽이 발생하는 경우
  - 웹서버를 통해 배포하게 되면 웹 서버의 용량이 기하 급수적으로 커져야 함
    - 클라우드 플랫폼을 사용하면 공급자는 웹서버를 최대한 줄일 수 있어 최소한으로 줄일 수 있음
  - 이러한 대규모 트래픽에 효과적으로 대응하기 위한 서비스



### IPSEC VPN

- 16분44초